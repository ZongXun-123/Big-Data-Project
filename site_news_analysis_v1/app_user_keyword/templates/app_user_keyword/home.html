{% extends 'base.html' %} {% block title %}
  使用者關鍵詞查詢
{% endblock %} {% block content %}
  <div class="col-lg-12">
    <h1>分析你關心的關鍵詞</h1>
    <p>可以針對你輸入的個別關鍵詞進行熱門程度分析</p>
  </div>
  <div class="col-lg-6 mb-2">
    <!-- 輸入條件區塊開始 -->
    <div class="card">
      <div class="card-header">
        <h3 class="h6 text-uppercase mb-0">輸入條件</h3>
      </div>
      <div class="card-body">
        <div class="mb-3 row">
          <label class="col-md-3 col-form-label">關心哪個關鍵詞?</label>
          <div class="col-md-9">
            <input id="input_keyword" name="userkey" value="烏克蘭 俄羅斯" class="form-control" />
            <div class="form-text text-muted">查找關鍵字，可輸入多個，空白隔開。主要以人名，產品，地理區域為主(搜尋斷詞後的詞語，並非全文搜尋)。</div>
          </div>
        </div>

        <div class="mb-3 row">
          <label class="col-sm-3 col-form-label">條件</label>

       <div class="col-md-9 mb-3">
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="radio" id="cond_and" value="and" name="condradio" />
              <label class="form-check-label" for="cond_and">and</label>
            </div>
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="radio" id="cond_or" value="or" name="condradio" checked />
              <label class="form-check-label" for="cond_or">or</label>
            </div>
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="radio" id="cond_single" value="single" name="condradio" checked />
              <label class="form-check-label" for="cond_single">single</label>
            </div>
          </div>
        </div>  

        <div class="mb-3 row">
          <label class="col-sm-3 col-form-label">新聞類別</label>
          <div class="col-md-9">
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="radio" id="cate_all" value="全部" name="cateradio" checked />
              <label class="form-check-label" for="cate_all">全部</label>
            </div>
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="radio" id="cate_politics" value="政治" name="cateradio" />
              <label class="form-check-label" for="cate_politics">政治</label>
            </div>
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="radio" id="cate_life" value="生活" name="cateradio" />
              <label class="form-check-label" for="cate_life">生活</label>
            </div>
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="radio" id="cate_international" value="國際" name="cateradio" />
              <label class="form-check-label" for="cate_international">國際</label>
            </div>
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="radio" id="cate_society" value="社會" name="cateradio" />
              <label class="form-check-label" for="cate_society">社會</label>
            </div>
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="radio" id="cate_local" value="地方" name="cateradio" />
              <label class="form-check-label" for="cate_local">地方</label>
            </div>
          </div>
        </div>
        <div class="mb-3 row">
          <label class="col-md-3 col-form-label">最近多少周?</label>
          <div class="col-md-9">
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="radio" id="wk1" value="1" name="wkradio" />
              <label class="form-check-label" for="wk1">1</label>
            </div>
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="radio" id="wk2" value="2" name="wkradio" checked />
              <label class="form-check-label" for="wk2">2</label>
            </div>
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="radio" id="wk3" value="3" name="wkradio" />
              <label class="form-check-label" for="wk3">3</label>
            </div>
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="radio" id="wk4" value="4" name="wkradio" />
              <label class="form-check-label" for="wk4">4</label>
            </div>
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="radio" id="wk6" value="6" name="wkradio" />
              <label class="form-check-label" for="wk6">6</label>
            </div>
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="radio" id="wk8" value="8" name="wkradio" />
              <label class="form-check-label" for="wk8">8</label>
            </div>
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="radio" id="wk12" value="12" name="wkradio" />
              <label class="form-check-label" for="wk12">12</label>
            </div>
            <div class="form-text text-muted">以最新資料時間為準，往前推多少周?</div>
          </div>
        </div>
        <div class="mb-3 row">
          <div class="col-md-9 ms-auto">
            <button type="button" id="btn_ok" class="btn btn-primary">查詢</button>
          </div>
        </div>
      </div>
    </div>
  </div>
  <!-- 輸入區塊結束 -->

  <!-- 顯示區塊 -->
  <div class="col-lg-6 mb-2">
    <div class="card">
      <div class="card-header">
        <h3 class="h6 text-uppercase mb-0">出現頻率以時間呈現</h3>
      </div>
      <div class="card-body">
        <small>觀察每個時間點的有多少篇報導(聲量大小)</small>
        <div class="row">
          <canvas id="keyword_time_line_chart"></canvas>
        </div>
      </div>
    </div>
  </div>
  <!-- 區塊結束 -->

  <!-- 同時出現的關鍵字區塊 -->
   <div class="col-lg-6 mb-2">
    <div class="card">
      <div class="card-header">
        <h3 class="h6 text-uppercase mb-0">熱門程度:有幾篇新聞報導提到它?</h3>
      </div>
      <div class="card-body">
        <ul id="keyword_article_count"></ul>
      </div>
    </div>
  </div>
  <!-- 區塊結束 -->

  <!-- 熱門程度區塊 -->
  <div class="col-lg-6 mb-2">
    <div class="card">
      <div class="card-header">
        <h3 class="h6 text-uppercase mb-0">熱門程度:提到它的次數?</h3>
      </div>
      <div class="card-body">
        <ul id="keyword_frequency"></ul>
      </div>
    </div>
  </div>
  <!-- 區塊結束 -->
  {% endblock %} {% block extra_js %}
  <!-- chartjs圖js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.13.0/moment.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.7.3/Chart.min.js"></script>

<script>
  call_ajax()

  // 註冊按鈕與 radio 事件
  $('#btn_ok').on('click', call_ajax)
  $("input[name='cateradio'], input[name='wkradio'], input[name='condradio']").on('change', call_ajax)

  function call_ajax() {
    const userkeys = $('#input_keyword').val().trim().split(/\s+/)
    const weeks = $("input[name='wkradio']:checked").val()
    const cate = $("input[name='cateradio']:checked").val()
    const cond = $("input[name='condradio']:checked").val()

    if (userkeys.length < 1 || userkeys[0].length < 2) {
      alert('請輸入至少一個長度大於兩字的關鍵字！')
      return
    }

    $.ajax({
      type: 'POST',
      url: 'api_get_top_userkey/',
      data: {
        userkey: userkeys.join(' '),
        cate: cate,
        weeks: weeks,
        cond: cond
      },
      success: function (received) {
        const article_count = received['key_occurrence_cat']
        const kwfreq = received['key_freq_cat']
        const data_key_time_freq = received['key_time_freq']

        console.log(article_count, kwfreq, data_key_time_freq)

        // 顯示出現篇數
        $('#keyword_article_count').empty()
        for (let key in article_count) {
          $('#keyword_article_count').append(`<li>${key}: ${article_count[key]}</li>`)
        }

        // 顯示關鍵字頻率
        $('#keyword_frequency').empty()
        for (let category in kwfreq) {
          let categoryItem = kwfreq[category]
          let keywordCount = []
          for (let keyword in categoryItem) {
            keywordCount.push(`${keyword}: ${categoryItem[keyword]}`)
          }
          $('#keyword_frequency').append(`<li><strong>${category}</strong>: ${keywordCount.join(', ')}</li>`)
        }

        // 顯示圖表
        showtimechart(data_key_time_freq, cond)
      }
    })
  }

  let line_chart = null

  function showtimechart(data_key_time_freq, cond) {
    const ctx_key_time = document.getElementById('keyword_time_line_chart').getContext('2d')
    const colors = ['red', 'blue', 'green', 'orange', 'purple', 'brown', 'teal']

    let datasets = []

    if (cond === 'single') {
      // 單一關鍵字各自畫一條線
      datasets = data_key_time_freq.map((item, index) => ({
        label: item.label || `關鍵字${index + 1}`,
        borderColor: colors[index % colors.length],
        backgroundColor: colors[index % colors.length] + '33',
        fill: false,
        data: item.data.map(d => ({
          x: new Date(d.x),
          y: d.y
        }))
      }))
    } else {
      // AND 或 OR，只畫一條線
      datasets = [{
        label: cond === 'and' ? 'AND 條件結果' : 'OR 條件結果',
        borderColor: 'red',
        backgroundColor: 'red33',
        fill: false,
        data: data_key_time_freq[0]?.data.map(d => ({
          x: new Date(d.x),
          y: d.y
        })) || []
      }]
    }

    const myoptions = {
      type: 'line',
      data: { datasets },
      options: {
        legend: { display: true },
        scales: {
          xAxes: [{
            type: 'time',
            time: {
              unit: 'day',
              displayFormats: { day: 'MM/DD' }
            },
            ticks: { autoSkip: true, maxRotation: 0, minRotation: 0 }
          }],
          yAxes: [{
            ticks: { beginAtZero: true },
            scaleLabel: {
              display: true,
              labelString: '出現次數'
            }
          }]
        }
      }
    }

    if (line_chart) {
      line_chart.destroy()
    }

    line_chart = new Chart(ctx_key_time, myoptions)
  }
</script>
  {% endblock %}